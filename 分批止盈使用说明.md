# 🎯 分批止盈功能使用说明

## ✨ 功能概述

现在我们的交易系统支持**分批止盈**功能！每个买入订单可以独立达到止盈条件并单独卖出，不再是一次性卖出所有持仓。

## 🔄 工作原理

### 原来的逻辑 ❌
```
下5单：100, 200, 300, 400, 500
成交后持仓：1500 USDC总价值
价格上涨达到止盈条件 → 一次性卖出所有持仓
```

### 现在的逻辑 ✅
```
下5单：100, 200, 300, 400, 500
每单独立计算止盈价格：
- 100单：买入价 + 0.6% = 止盈价1
- 200单：买入价 + 0.6% = 止盈价2  
- 300单：买入价 + 0.6% = 止盈价3
- 400单：买入价 + 0.6% = 止盈价4
- 500单：买入价 + 0.6% = 止盈价5

当前价格 ≥ 止盈价1 → 只卖出100单对应的数量
当前价格 ≥ 止盈价2 → 只卖出200单对应的数量
...以此类推
```

## 📊 统计显示

### 实时监控界面
```
===== Backpack 自动交易系统 =====
交易对: BTC_USDC
总订单数: 5
已成交订单: 5
成交总金额: 1500.00 USDC
成交总数量: 0.015000 BTC

===== 分批止盈统计 =====
已成交买单: 5
已触发止盈: 2
已完全卖出: 1
待卖出订单: 1
剩余可卖数量: 0.008500 BTC
止盈完成率: 20.0%
```

### 详细订单状态
```
=== 订单详细状态 ===
订单 12345: 买入价=45000.00, 数量=0.002222, 状态=已完全卖出
  └─ 止盈价格: 45270.00 USDC
订单 12346: 买入价=44000.00, 数量=0.004545, 状态=待卖出(0.004545)
  └─ 止盈价格: 44264.00 USDC
订单 12347: 买入价=43000.00, 数量=0.006977, 状态=等待止盈
  └─ 止盈价格: 43258.00 USDC
```

## ⚙️ 配置说明

不需要修改任何配置文件！分批止盈功能使用现有的止盈配置：

```json
{
  "trading": {
    "takeProfitPercentage": 0.6  // 每单都按各自买入价+0.6%计算止盈
  }
}
```

## 🚀 使用方法

### 1. 启动系统
```bash
node src/index.js
```

### 2. 系统自动工作
- 创建多个递增买入订单
- 监控每个订单的成交状态
- 为每个成交的订单计算独立的止盈价格
- 实时监控价格，达到条件时创建对应的卖出订单

### 3. 观察统计信息
- **已触发止盈**：有多少个订单达到了止盈条件
- **已完全卖出**：有多少个订单已经完全卖出
- **待卖出订单**：有多少个订单已触发止盈但还未完全卖出
- **剩余可卖数量**：还有多少数量可以卖出

## 💡 优势

### 🎯 精确控制
- 每个订单独立管理，精确到每一笔交易
- 不会因为部分订单盈利就强制卖出所有持仓

### 📈 收益优化
- 允许部分止盈，部分继续持有
- 可以在不同价格点分批获利

### 🛡️ 风险分散
- 降低一次性卖出的风险
- 可以适应不同的市场波动

### 📊 清晰统计
- 实时显示每个订单的状态
- 详细的止盈进度跟踪

## 🔍 示例场景

### 场景1：逐步止盈
```
当前价格 43500 USDC：
- ✅ 100单 (买入价 43000) 已触发止盈并卖出
- ⏳ 200单 (买入价 43200) 等待止盈 (还需涨到 43459)
- ⏳ 300单 (买入价 43400) 等待止盈 (还需涨到 43660)
- ⏳ 400单、500单 等待止盈
```

### 场景2：部分止盈
```
市场回调时：
- ✅ 已卖出：100单、200单 (已获利)
- 📉 价格回落：300单、400单、500单 继续持有
- 💰 结果：既获得了部分利润，又保留了部分仓位
```

## ⚡ 立即体验

现在就可以启动系统体验分批止盈功能：

```bash
# 启动系统
node src/index.js

# 观察日志输出，会看到：
# "===== 订单 12345 达到止盈条件！====="
# "为订单 12345 创建卖出订单: 0.002222 BTC @ 45270.00 USDC"
```

**真正实现了你想要的：100单独止盈、200单独止盈、300单独止盈...的功能！** 🎉